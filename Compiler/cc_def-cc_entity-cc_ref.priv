----------------------------------------------------------------------------------------------------
module private cc_ref =
-- Překladač Flexu.
-- Reference mezi entitami.
----------------------------------------------------------------------------------------------------
-- Ondra : 25.06.2001 : Vytvořil
----------------------------------------------------------------------------------------------------

with
  cc_def.cc_gc;

----------------------------------------------------------------------------------------------------
class private ref0 = 
-- Reference na objekt
----------------------------------------------------------------------------------------------------

    ------------------------------------------------------------------------------------------------
    static geteval =
    -- Zjistí úroveň vyhodnocení reference.
    ------------------------------------------------------------------------------------------------
    begin
      result:=e;
      end geteval;



    ------------------------------------------------------------------------------------------------
    static seteval =
    -- Nastaví novou úroveň vyhodnocení reference.
    ------------------------------------------------------------------------------------------------
    begin
      this.e:=e;
      end seteval;

    end ref0;



----------------------------------------------------------------------------------------------------
class private refexpr =
-- Reference na objekt: výraz
----------------------------------------------------------------------------------------------------

    var
      _x           : p_flex_construct;           -- související výraz

    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference přiřazena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x<>nil;
      end isset;



    ------------------------------------------------------------------------------------------------
    static getuexpr =
    -- Vrátí odkazovaný výraz. Pokud není přiřazen, vrátí NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x;
      end getuexpr;



    ------------------------------------------------------------------------------------------------
    static getcexpr =
    -- Vrátí odkazovaný výraz. Pokud není přiřazen, způsobí interní chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify({VERIFY=}000057,_x=nil);
      result:=_x;
      end getcexpr;



    ------------------------------------------------------------------------------------------------
    static setexpr =
    -- Přiřadí do reference výraz.
    ------------------------------------------------------------------------------------------------
    begin
      _x:=x;
      end setexpr;


    ------------------------------------------------------------------------------------------------
    static errpos =
    -- Pozice chyby ve zdrojáku.
    ------------------------------------------------------------------------------------------------
    begin
      verify({VERIFY=}000193,_x=nil);
      _x^.errpos;
      {%%TODO(VIRTUAL) pexpnode(_x)^.errpos;}
      { nahradit voláním obecné virtuální metody errpos (x : in virtual p_flex_class); }      
      end errpos;

    end refexpr;



----------------------------------------------------------------------------------------------------
class private ref1 =
-- Reference na objekt s výrazem
----------------------------------------------------------------------------------------------------

    ------------------------------------------------------------------------------------------------
    static getrefexpr =
    -- Vrátí odkaz na související výraz.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x;
      end getrefexpr;



    ------------------------------------------------------------------------------------------------
    static getuexpr =
    -- Vrátí odkazovaný výraz. Pokud není přiřazen, vrátí NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x^.getuexpr;
      end getuexpr;



    ------------------------------------------------------------------------------------------------
    static getcexpr =
    -- Vrátí odkazovaný výraz. Pokud není přiřazen, způsobí interní chybu.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x^.getcexpr;
      end getcexpr;



    ------------------------------------------------------------------------------------------------
    static setexpr =
    -- Přiřadí do reference výraz.
    ------------------------------------------------------------------------------------------------
    begin
      _x^.setexpr(x);
      end setexpr;



    ------------------------------------------------------------------------------------------------
    entry =
    -- Inicializace.
    ------------------------------------------------------------------------------------------------
    begin
      new _x;
      c_garbage_collector.get_instance^.register_class(_x);
      end entry;


  { %%TODO(ADJUST) Nemůžeme to discardovat, protože se nikde nevolá adjust a nechceme si přeci
    pod rukama uvolnit paměť.

    ------------------------------------------------------------------------------------------------
    exit =
    -- Inicializace.
    ------------------------------------------------------------------------------------------------
    begin
      discard _x;
      end exit;
  }
    end ref1;



----------------------------------------------------------------------------------------------------
class private reftype =
-- Reference na objekt: typ
----------------------------------------------------------------------------------------------------

    var
      _t           : pentity_type;               -- typ

    ------------------------------------------------------------------------------------------------
    static getutype =
    -- Vrátí odkazovaný typ. Pokud není přiřazen, vrátí NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_t;
      end getutype;



    ------------------------------------------------------------------------------------------------
    static getctype =
    -- Vrátí odkazovaný typ. Pokud není přiřazen, způsobí interní chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify({VERIFY=}000053,_t=nil);
      result:=_t;
      end getctype;



    ------------------------------------------------------------------------------------------------
    static settype =
    -- Přiřadí do reference typ.
    ------------------------------------------------------------------------------------------------
    begin
      -- kontrola konzistence: jestliže je výraz už nastaven, musí být v typu nastaven stejný
      -- výraz, jinak se ten zde nastavený na věky zapomene
      verify({VERIFY=}000729,clear_expr and then _x^.isset and then _x^.getuexpr<>__get_type_expr(ptyp));

      -- nastavit typ
      _t:=ptyp;

      -- nastavt výraz související s typem
      if clear_expr then
        _x^.setexpr(__get_type_expr(ptyp));
        end if;
      end settype;



    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference přiřazena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=(_t<>nil) or _x^.isset;
      end isset;



    ------------------------------------------------------------------------------------------------
    static errpos =
    -- Pozice chyby ve zdrojáku.
    ------------------------------------------------------------------------------------------------
    begin
      if _x^.isset
        then _x^.errpos
        else  
          verify({VERIFY=}000762,_t=nil);
          --ce.setpos(_t^.pos[sp_header]);
          end if;
      end errpos;

    end reftype;



----------------------------------------------------------------------------------------------------
class private refblock =
-- Reference na objekt: blok příkazů
----------------------------------------------------------------------------------------------------

    var
      _b           : p_flex_class;               -- související blok příkazů

    ------------------------------------------------------------------------------------------------
    static setblock =
    -- Přiřadí do reference blok.
    ------------------------------------------------------------------------------------------------
    begin
      _b:=b;
      end setblock;



    ------------------------------------------------------------------------------------------------
    static getublock =
    -- Vrátí odkazovaný blok. Pokud není přiřazen, vrátí NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_b;
      end getublock;



    ------------------------------------------------------------------------------------------------
    static getcblock =
    -- Vrátí odkazovaný blok. Pokud není přiřazen, způsobí interní chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify({VERIFY=}000475,_b=nil);
      result:=_b;
      end getcblock;



    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference přiřazena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_b<>nil;
      end isset;

    end refblock;



----------------------------------------------------------------------------------------------------
class private refentity =
-- Reference na objekt: entita
----------------------------------------------------------------------------------------------------

    var
      _e           : pentity;                    -- symbol

    ------------------------------------------------------------------------------------------------
    static setentity =
    -- Přiřadí do reference symbol.
    ------------------------------------------------------------------------------------------------
    begin
      _e:=e;
      end setentity;



    ------------------------------------------------------------------------------------------------
    static getuentity =
    -- Vrátí odkazovaný symbol. Pokud není přiřazen, vrátí NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_e;
      end getuentity;



    ------------------------------------------------------------------------------------------------
    static getcentity =
    -- Vrátí odkazovaný symbol. Pokud není přiřazen, způsobí interní chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify({VERIFY=}000054,_e=nil);
      result:=_e;
      end getcentity;



    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference přiřazena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_e<>nil or _x^.isset;
      end isset;



    ------------------------------------------------------------------------------------------------
    static errpos =
    -- Pozice chyby ve zdrojáku.
    ------------------------------------------------------------------------------------------------
    begin
      if _x^.isset
        then _x^.errpos
        else
          verify({VERIFY=}000763,_e=nil);
          --ce.setpos(_e^.pos[sp_header]);
          end if;
      end errpos;

    end refentity;



----------------------------------------------------------------------------------------------------
class private refimm =
-- Reference na objekt: přímá hodnota
----------------------------------------------------------------------------------------------------

    var
      _i           : aliased timm_value;         -- přímá hodnota

    ------------------------------------------------------------------------------------------------
    static getuimm =
    -- Vrátí pointer na odkazovanou přímou hodnotu.
    ------------------------------------------------------------------------------------------------
    begin
      result:=^_i;
      end getuimm;



    ------------------------------------------------------------------------------------------------
    static getimm =
    -- Vrátí pointer na odkazovanou přímou hodnotu.
    -- Pokud je přímá hodnota typu IC_UNDEF, způsobí interní chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify({VERIFY=}000056,_i.ic=ic_undef);
      result:=^_i;
      end getimm;



    ------------------------------------------------------------------------------------------------
    static getundefimm =
    -- Vrátí pointer na odkazovanou přímou hodnotu.
    -- Pokud přímá hodnota není typu IC_UNDEF, způsobí interní chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify({VERIFY=}000613,_i.ic<>ic_undef);
      result:=^_i;
      end getundefimm;



    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference přiřazena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_i.ic<>ic_undef or _x^.isset;
      end isset;



    ------------------------------------------------------------------------------------------------
    static errpos =
    -- Pozice chyby ve zdrojáku.
    ------------------------------------------------------------------------------------------------
    begin
      _x^.errpos;
      end errpos;
      
    end refimm;

end cc_ref;
