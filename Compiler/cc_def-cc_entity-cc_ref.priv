----------------------------------------------------------------------------------------------------
module private cc_ref =
-- P©eklada‡ Flexu.
-- Reference mezi entitami.
----------------------------------------------------------------------------------------------------
-- Ondra : 25.06.2001 : Vytvo©il
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
class private ref0 = 
-- Reference na objekt
----------------------------------------------------------------------------------------------------

    use
      cc_def.cc_lexsym;

    var
      pos          : cc_lexsym.lexposblock;      -- pozice reference

    ------------------------------------------------------------------------------------------------
    static geteval =
    -- Zjist¡ £rove¤ vyhodnocen¡ reference.
    ------------------------------------------------------------------------------------------------
    begin
      result:=e;
      end geteval;



    ------------------------------------------------------------------------------------------------
    static seteval =
    -- Nastav¡ novou £rove¤ vyhodnocen¡ reference.
    ------------------------------------------------------------------------------------------------
    begin
      this.e:=e;
      end seteval;



    end ref0;



----------------------------------------------------------------------------------------------------
class private refexpr =
-- Reference na objekt: v˜raz
----------------------------------------------------------------------------------------------------

    var
      _x           : p_flex_construct;           -- souvisej¡c¡ v˜raz

    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference p©i©azena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x<>nil;
      end isset;



    ------------------------------------------------------------------------------------------------
    static getuexpr =
    -- Vr t¡ odkazovan˜ v˜raz. Pokud nen¡ p©i©azen, vr t¡ NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x;
      end getuexpr;



    ------------------------------------------------------------------------------------------------
    static getcexpr =
    -- Vr t¡ odkazovan˜ v˜raz. Pokud nen¡ p©i©azen, zp–sob¡ intern¡ chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify(57,_x=nil);
      result:=_x;
      end getcexpr;



    ------------------------------------------------------------------------------------------------
    static setexpr =
    -- P©i©ad¡ do reference v˜raz.
    ------------------------------------------------------------------------------------------------
    begin
      _x:=x;
      end setexpr;


    ------------------------------------------------------------------------------------------------
    static errpos =
    -- Pozice chyby ve zdroj ku.
    ------------------------------------------------------------------------------------------------
    begin
      verify(193,_x=nil);
      _x^.errpos;
      {%%TODO(VIRTUAL) pexpnode(_x)^.errpos;}
      { nahradit vol n¡m obecn‚ virtu ln¡ metody errpos (x : in virtual p_flex_class); }      
      end errpos;

    end refexpr;



----------------------------------------------------------------------------------------------------
class private ref1 =
-- Reference na objekt s v˜razem
----------------------------------------------------------------------------------------------------

    ------------------------------------------------------------------------------------------------
    static getrefexpr =
    -- Vr t¡ odkaz na souvisej¡c¡ v˜raz.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x;
      end getrefexpr;



    ------------------------------------------------------------------------------------------------
    static getuexpr =
    -- Vr t¡ odkazovan˜ v˜raz. Pokud nen¡ p©i©azen, vr t¡ NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x^.getuexpr;
      end getuexpr;



    ------------------------------------------------------------------------------------------------
    static getcexpr =
    -- Vr t¡ odkazovan˜ v˜raz. Pokud nen¡ p©i©azen, zp–sob¡ intern¡ chybu.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_x^.getcexpr;
      end getcexpr;



    ------------------------------------------------------------------------------------------------
    static setexpr =
    -- P©i©ad¡ do reference v˜raz.
    ------------------------------------------------------------------------------------------------
    begin
      _x^.setexpr(x);
      end setexpr;



    ------------------------------------------------------------------------------------------------
    entry =
    -- Inicializace.
    ------------------------------------------------------------------------------------------------
    begin
      new _x;
      end entry;


  { %%TODO(ADJUST) Nem–‘eme to discardovat, proto‘e se nikde nevol  adjust a nechceme si p©eci
    pod rukama uvolnit pamˆŸ.

    ------------------------------------------------------------------------------------------------
    exit =
    -- Inicializace.
    ------------------------------------------------------------------------------------------------
    begin
      discard _x;
      end exit;
  }
    end ref1;



----------------------------------------------------------------------------------------------------
class private reftype =
-- Reference na objekt: typ
----------------------------------------------------------------------------------------------------

    var
      _t           : pentity_type;               -- typ

    ------------------------------------------------------------------------------------------------
    static getutype =
    -- Vr t¡ odkazovan˜ typ. Pokud nen¡ p©i©azen, vr t¡ NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_t;
      end getutype;



    ------------------------------------------------------------------------------------------------
    static getctype =
    -- Vr t¡ odkazovan˜ typ. Pokud nen¡ p©i©azen, zp–sob¡ intern¡ chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify(53,_t=nil);
      result:=_t;
      end getctype;



    ------------------------------------------------------------------------------------------------
    static settype =
    -- P©i©ad¡ do reference typ.
    ------------------------------------------------------------------------------------------------
    begin
      -- kontrola konzistence: jestli‘e je v˜raz u‘ nastaven, mus¡ b˜t v typu nastaven stejn˜
      -- v˜raz, jinak se ten zde nastaven˜ na vˆky zapomene
      verify(729,clear_expr and then _x^.isset and then _x^.getuexpr<>__get_type_expr(ptyp));

      -- nastavit typ
      _t:=ptyp;

      -- nastavt v˜raz souvisej¡c¡ s typem
      if clear_expr then
        _x^.setexpr(__get_type_expr(ptyp));
        end if;
      end settype;



    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference p©i©azena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=(_t<>nil) or _x^.isset;
      end isset;



    ------------------------------------------------------------------------------------------------
    static errpos =
    -- Pozice chyby ve zdroj ku.
    ------------------------------------------------------------------------------------------------
    begin
      if _x^.isset
        then _x^.errpos
        else  
          verify(194,_t=nil);
          --ce.setpos(_t^.pos[sp_header]);
          end if;
      end errpos;

    end reftype;



----------------------------------------------------------------------------------------------------
class private refblock =
-- Reference na objekt: blok p©¡kaz–
----------------------------------------------------------------------------------------------------

    var
      _b           : p_flex_class;               -- souvisej¡c¡ blok p©¡kaz–

    ------------------------------------------------------------------------------------------------
    static setblock =
    -- P©i©ad¡ do reference blok.
    ------------------------------------------------------------------------------------------------
    begin
      _b:=b;
      end setblock;



    ------------------------------------------------------------------------------------------------
    static getublock =
    -- Vr t¡ odkazovan˜ blok. Pokud nen¡ p©i©azen, vr t¡ NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_b;
      end getublock;



    ------------------------------------------------------------------------------------------------
    static getcblock =
    -- Vr t¡ odkazovan˜ blok. Pokud nen¡ p©i©azen, zp–sob¡ intern¡ chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify(475,_b=nil);
      result:=_b;
      end getcblock;



    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference p©i©azena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_b<>nil;
      end isset;

    end refblock;



----------------------------------------------------------------------------------------------------
class private refentity =
-- Reference na objekt: entita
----------------------------------------------------------------------------------------------------

    var
      _e           : pentity;                    -- symbol

    ------------------------------------------------------------------------------------------------
    static setentity =
    -- P©i©ad¡ do reference symbol.
    ------------------------------------------------------------------------------------------------
    begin
      _e:=e;
      end setentity;



    ------------------------------------------------------------------------------------------------
    static getuentity =
    -- Vr t¡ odkazovan˜ symbol. Pokud nen¡ p©i©azen, vr t¡ NIL.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_e;
      end getuentity;



    ------------------------------------------------------------------------------------------------
    static getcentity =
    -- Vr t¡ odkazovan˜ symbol. Pokud nen¡ p©i©azen, zp–sob¡ intern¡ chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify(54,_e=nil);
      result:=_e;
      end getcentity;



    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference p©i©azena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_e<>nil or _x^.isset;
      end isset;



    ------------------------------------------------------------------------------------------------
    static errpos =
    -- Pozice chyby ve zdroj ku.
    ------------------------------------------------------------------------------------------------
    begin
      if _x^.isset
        then _x^.errpos
        else
          verify(194,_e=nil);
          --ce.setpos(_e^.pos[sp_header]);
          end if;
      end errpos;

    end refentity;



----------------------------------------------------------------------------------------------------
class private refimm =
-- Reference na objekt: p©¡m  hodnota
----------------------------------------------------------------------------------------------------

    var
      _i           : aliased timm_value;         -- p©¡m  hodnota

    ------------------------------------------------------------------------------------------------
    static getimm =
    -- Vr t¡ pointer na odkazovanou p©¡mou hodnotu.
    -- Pokud je p©¡m  hodnota typu IC_UNDEF, zp–sob¡ intern¡ chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify(56,_i.ic=ic_undef);
      result:=pimm_value(^_i);
      end getimm;



    ------------------------------------------------------------------------------------------------
    static getundefimm =
    -- Vr t¡ pointer na odkazovanou p©¡mou hodnotu.
    -- Pokud p©¡m  hodnota nen¡ typu IC_UNDEF, zp–sob¡ intern¡ chybu.
    ------------------------------------------------------------------------------------------------
    begin
      verify(613,_i.ic<>ic_undef);
      result:=pimm_value(^_i);
      end getundefimm;



    ------------------------------------------------------------------------------------------------
    static isset =
    -- True, je-li reference p©i©azena.
    ------------------------------------------------------------------------------------------------
    begin
      result:=_i.ic<>ic_undef or _x^.isset;
      end isset;



    ------------------------------------------------------------------------------------------------
    static errpos =
    -- Pozice chyby ve zdroj ku.
    ------------------------------------------------------------------------------------------------
    begin
      _x^.errpos;
      end errpos;
      
    end refimm;

end cc_ref;