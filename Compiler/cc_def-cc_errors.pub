----------------------------------------------------------------------------------------------------
class public cc_errors =
-- Překladač Flexu.
-- Chybová hlášení.
----------------------------------------------------------------------------------------------------

----- %%TECH Hlášení chyb, varování a zpráv --------------------------------------------------------
--
-- Existuje unifikovaný mechanismus pro vytvoření hlášení během překladu:
--
--     CE.SETERROR | CE.SETWARNING | CE.SETMSG
--     [ SETPARAM ]
--     [ SETINFO ]
--     [ SETPOS/LOADPOS ]
--
-- Chyby, ze kterých se nelze zotavit, se šíří příkazem CE.RAISEERROR jako
-- výjimka COMPILER_ERROR.
--   Chyby, ze kterých se lze na nějaké (zpravidla nejbližsí) vyšší úrovni
-- překladače zotavit, se šíří příkazem CE.RESUMEERROR nebo prostým EXIT
-- z procedury. Zotavení z chyby pak představuje obsloužení výjimky
-- RESUME_ERROR.
--   Ve fatálních případech může překladač vyvolat výjimky MEMORY_ERROR nebo
-- INTERNAL_ERROR.
----------------------------------------------------------------------------------------------------

with
  standard.structures,
  standard.structures.lists,
  cc_def.cc_codes,
  cc_def.cc_entity;

use
  cc_def.cc_lexsym;  

extend
  c_flex_class;

type
  -- unikátní číslo hlášení
  t_message_num    = protected t_unsigned;       

  -- obecné hlášení
  tmsgdesc         = t_list_item with record
      num          : t_message_num;              -- unikátní číslo hlášení
      pos          : cc_lexsym.lexposblock;      -- pozice chyby
      -- %%TODO(TAG) odstranit
      typ          : enum mt_error; mt_warning; mt_hint; mt_diag; mt_message; end enum;
      end record;

  -- hlášení s doplňujícími údaji
  tmsgdesc_extended= tmsgdesc with record
      param        : p_char32ustr;               -- volitelný parametr hlášení
      info         : p_char32ustr;               -- doplňující popis hlášení
      end record;

  -- chyba
  tmsgdesc_error   = tmsgdesc_extended with record
      error_code   : terrorcode;                 -- kód chyby
      end record;

  -- varování
  tmsgdesc_warning = tmsgdesc_extended with record
      warn_code    : twarningcode;               -- kód varování
      end record;

  -- hint
  tmsgdesc_hint    = tmsgdesc_extended with record
      hint_code    : thintcode;                  -- kód hintu
      end record;

  -- diagnostické hlášení
  tmsgdesc_diag    = tmsgdesc_extended with record
      diag_code    : tdiagcode;                  -- kód diagnostického hlášení
      end record;

  -- zpráva
  tmsgdesc_message = tmsgdesc with record
      msg          : p_char32ustr;               -- text zprávy
      end record;

  -- pointery
  pmsgdesc         = ^class tmsgdesc;
  pmsgdesc_extended= ^class tmsgdesc_extended;
  pmsgdesc_error   = ^class tmsgdesc_error;
  pmsgdesc_warning = ^class tmsgdesc_warning;
  pmsgdesc_hint    = ^class tmsgdesc_hint;
  pmsgdesc_diag    = ^class tmsgdesc_diag;
  pmsgdesc_message = ^class tmsgdesc_message;

var
  msglist          : protected aliased t_list;   -- seznam hlášení
  error_count      : protected t_unsigned32;               -- počet chyb - kolikrát bylo zavoláno [seterror]
----------------------------------------------------------------------------------------------------
static seterror (
    _num           : in t_message_num;           -- číslo chyby
    _code          : in terrorcode);             -- kód chyby
-- Vytvoří záznam o chybě.
----------------------------------------------------------------------------------------------------
static setwarning (
    context        : in tcontext;                -- aktuální kontext
    _num           : in t_message_num;           -- číslo chyby
    _code          : in twarningcode);           -- kód varování
-- Vytvoří záznam o varování.
----------------------------------------------------------------------------------------------------
static sethint (
    context        : in tcontext;                -- aktuální kontext
    _num           : in t_message_num;	         -- číslo hintu
    _code          : in thintcode);              -- kód hintu
-- Vytvoří záznam o hintu.
----------------------------------------------------------------------------------------------------
static setdiag (
    context        : in tcontext;                -- aktuální kontext
    _num           : in t_message_num;	         -- číslo diagu
    _code          : in tdiagcode);              -- kód diagu
-- Vytvoří záznam o diagu.
----------------------------------------------------------------------------------------------------
static setmsg (
    _num           : in t_message_num;           -- číslo chyby
    _msg           : in t_char32str);            -- zpráva
-- Vytvoří záznam o zprávě.
----------------------------------------------------------------------------------------------------
static setparam (
    _param         : in t_char32str);            -- doplnkovy text
-- Do posledniho hlaseni dosadi doplnkovy text
----------------------------------------------------------------------------------------------------
static setinfo (
    _info          : in t_char32str);            -- popis chyby
-- K poslednimu hlaseni pripoji doplnkovy popis chyby.
----------------------------------------------------------------------------------------------------
static loadpos;
-- Doplní pozici posledního hlášení podle posledního symbolu.
----------------------------------------------------------------------------------------------------
static loadpos2;
-- Doplní pozici posledního hlášení podle posledních dvou symbolů.
----------------------------------------------------------------------------------------------------
static loadtextpos;
-- Doplní pozici posledního hlášení podle aktuální pozice ve zdrojáku.
----------------------------------------------------------------------------------------------------
static setpos (
    pos            : in cc_lexsym.lexposblock);  -- pozice symbolu
-- Doplní pozici posledního hlášení.
----------------------------------------------------------------------------------------------------
static raiseerror;
-- Vyvolá výjimku COMPILER_ERROR.
----------------------------------------------------------------------------------------------------
static resumeerror;
-- Vyvolá výjimku RESUME_ERROR.
----------------------------------------------------------------------------------------------------
static testerror return t_logical;
-- True, je-li nastaven příznak chyby.
----------------------------------------------------------------------------------------------------
static testany return t_logical;
-- True, jsou-li k dispozici nějaká hlášení.
----------------------------------------------------------------------------------------------------

end cc_errors;
