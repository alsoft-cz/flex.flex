----------------------------------------------------------------------------------------------------
module public cc_text =
-- P©eklada‡ Flexu.
-- €ten¡ zdroj ku.
----------------------------------------------------------------------------------------------------
-- Ondra : 25.04.2000 : Vytvo©il
----------------------------------------------------------------------------------------------------

with
  standard,
  standard.names,
  standard.files,
  cc_def;

extend
  cc_def.cc_lexsym;

-- dop©edn‚ deklarace
class c_source_text; type p_source_text = ^class c_source_text;

----------------------------------------------------------------------------------------------------
class public c_source_text = extend c_flex_class;
-- Reprezentace textov‚ho souboru. 
-- Poskytuje z kladn¡ primitiva pro ‡ten¡ textu po znac¡ch.
----------------------------------------------------------------------------------------------------

    var
      include      : protected t_logical;        -- T-je to includovan˜ soubor
      effective    : t_logical;                  -- T-posledn¡ zpracov van˜ © dek byl efektivn¡

      -- buffer na pozice lexik ln¡ch element– (jsou pot©eba pozice 2 element–)
      posbuf       : array lexlevel of lexpos;

      -- z sobn¡k preprocesoru
      metastack    : {%%TODO(REF)} string 100 of tmetastackitem;

    ------------------------------------------------------------------------------------------------
    static init (
        name       : in t_text_name;             -- jm‚no otv¡ran‚ho souboru
        include    : in t_logical);              -- T-soubor je includovan˜
    -- Otev©e soubor a p©iprav¡ ho pro ‡ten¡.
    ------------------------------------------------------------------------------------------------
    static getchar (
        c          : out lexchar);               -- znak p©e‡ten˜ ze souboru
    -- P©e‡te znak ze vstupu. Na konci vstupu vr t¡ \0, p©¡padn‚ znaky \0 v souboru nijak 
    -- neo¨et©uje, tak‘e se u‘ivatel mus¡ je¨tˆ ujistit vol n¡m [is_eof].
    -- Po p©e‡ten¡ nov‚ho znaku ze vstupu inkrementuje po‡¡tadlo sloupc–. Nijak neo¨et©uje konce
    -- © dk–. Aktualizace po‡¡tadla © dk– je ponech na na u‘ivateli.
    ------------------------------------------------------------------------------------------------
    static ungetchar;
    -- Vr t¡ naposledy p©e‡ten˜ znak do vstupu.
    ------------------------------------------------------------------------------------------------
    static next_line;
    -- Posune po‡¡tadlo © dk– o jedni‡ku a zresetuje po‡¡tadlo sloupc–.
    ------------------------------------------------------------------------------------------------
    static check_meta_statements;
    -- Zkontroluje, zda jsou uzav©eny v¨echny blokov‚ metap©¡kazy.
    ------------------------------------------------------------------------------------------------
    static is_eof return t_logical;
    -- True, jestli‘e ji‘ byl p©e‡ten cel˜ soubor.
    ------------------------------------------------------------------------------------------------
    static get_lines return t_unsigned;
    -- Dosud zpracovan˜ po‡et © dk– souboru.
    ------------------------------------------------------------------------------------------------
    static get_position (
        pos        : out lexpos);                -- pozice
    -- Zjist¡ aktu ln¡ pozici ve zdroj ku.
    ------------------------------------------------------------------------------------------------
    static get_length (
        pos        : in out lexpos);             -- pozice
    -- Podle zapamatovan‚ pozice dopo‡¡t  d‚lku lexik ln¡ho elementu.
    ------------------------------------------------------------------------------------------------

  supervised

    var
      f            : c_file;                     -- vstupn¡ soubor
      next         : p_source_text;              -- dal¨¡ soubor na z sobn¡ku

    end c_source_text;

----------------------------------------------------------------------------------------------------
procedure text_open (
    name           : in t_text_name;             -- jm‚no otv¡ran‚ho souboru
    include        : in t_logical);              -- T-soubor je includovan˜
-- Otev©e nov˜ soubor zadan‚ho jm‚na a um¡st¡ ho na vrchol z sobn¡ku otev©en˜ch soubor–.
----------------------------------------------------------------------------------------------------
procedure text_close;
-- Zav©e soubor na vrcholu z sobn¡ku otev©en˜ch soubor– a p©ejde k nad©azen‚mu.
-- P©ed zav©en¡m zkontroluje ukon‡en¡ v¨ech blokov˜ch metap©¡kaz– v aktu ln¡m souboru.
----------------------------------------------------------------------------------------------------

--%%TODO(SUPERVISED) supervised

var
  -- z sobn¡k vstupn¡ch soubor–
  lex_input        : p_source_text;

end cc_text;