----------------------------------------------------------------------------------------------------
module public cl_resolver =
-- Překladač Flexu.
-- Vyhodnocovač cross-referencí a adres.
----------------------------------------------------------------------------------------------------
-- Ondra : 12.04.2002 : Vytvořil
----------------------------------------------------------------------------------------------------

with
  standard,
  standard.files,
  standard.streams,
  cc_def.cc_unitype,
  cc_def.cc_entity.cc_list;

-- dopředné deklarace
class abstract linkresolver; type p_linkresolver = ^class linkresolver;

type
  -- typ segmentu
  tsegment         = enum
      tseg_code;                                 -- kód
      tseg_const;                                -- const data
      tseg_init;                                 -- inicializovaná data
      tseg_data;                                 -- neinicializovaná data
      tseg_import;                               -- importy
      tseg_metadata;                             -- metadata (deskriptory entit)
      tseg_export;                               -- exporty
      end enum;

type 
  -- dispozice relokace
  t_relo_disposition = enum
     trd_absolute;                               -- absolutní relokace
     trd_relative;                               -- relativní relokace
     end enum;

  -- seznam relokabilních odkazů
  t_relocations    = string of record
      disposition  : t_relo_disposition;         -- dispozice relokace (absolutní, relativní,...)
      address      : t_unsigned;                 -- absolutní adresa relokabilního pole
      end record;
  p_relocations    = ^t_relocations;


----------------------------------------------------------------------------------------------------
class public abstract linkresolver = 
-- Vyhodnocovač cross-referencí a adres.
----------------------------------------------------------------------------------------------------

    with
      cc_base,
      cc_base.cc_util;

    extend 
      c_flex_class;

    var
      -- seznamy entit zařazených do jednotlivých segmentů
      code         : protected tentitystring;    -- symboly zařazené v code segmentu
      reloc        : protected tentitystring;    -- symboly vyžadující vyhodnocení relokací
      cdata        : protected timmstring;       -- přímé hodnoty zařazené v const data seg
      idata        : protected tentitystring;    -- symboly zařazené v inicializovaném data seg
      data         : protected tentitystring;    -- symboly zažazené v neinic. data segmentu
      import       : protected tentitystring;    -- externí symboly
      metadata     : protected tentitystring;    -- seznam entit, pro které se generují deskriptory

    ------------------------------------------------------------------------------------------------
    static mark_all (
        curr       : in pentity);                -- symbol
    -- Fáze 1: Označení všech entit pro linkování.
    ------------------------------------------------------------------------------------------------
    virtual abstract link;
    -- Fáze 2: Vlastní sestavení.
    ----------------------------------------------------------------------------------------------
    virtual abstract info;
    -- Výpis souhrnných informací do listingu.
    ----------------------------------------------------------------------------------------------
    virtual abstract getaddrbase return tunicode_addr;
    -- Bázová adresa, ke které se vztahují relokace.
    ----------------------------------------------------------------------------------------------
    virtual abstract getentrypoint return tunicode_addr;
    -- Entrypoint programu.
    ----------------------------------------------------------------------------------------------
    virtual abstract checkseg (
        _seg       : in tsegment)                -- segment
        return t_logical;                        -- T-zahrnout do EXE
    -- True, pokud se má zadaný segment zahrnout do EXE.
    ----------------------------------------------------------------------------------------------
    virtual abstract getsegbase (
        _seg       : in tsegment)                -- segment
        return tunicode_addr;                    -- bázová adresa segmentu
    -- Bázová adresa segmentu.
    ----------------------------------------------------------------------------------------------
    virtual abstract getsegtotal (
        _seg       : in tsegment)                -- segment
        return tunidata_size;                    -- velikost segmentu
    -- Celková velikost segmentu.
    ----------------------------------------------------------------------------------------------
    virtual abstract writesegment (
        _seg       : in tsegment;                -- segment
        os         : in p_stream_binary_writer);        -- výstupní soubor
    -- Do výstupního souboru zapíše zadaný segment.
    ----------------------------------------------------------------------------------------------
    static get_sorted_relocations_by_partition_id (
        partition  : in t_partition_id;          -- ID cílové partition
        relocations: out p_relocations);         -- seznam relokabilních adres
    -- Vrátí seznam relokabilních adres, které směřují do uvedené cílové partition
    ------------------------------------------------------------------------------------------------

  protected

    type
      -- procedura pro sestavení jednoho segmentu
      t_link_segment = procedure (
          _address   : in out c_address_aligner_32); -- přidělovač adres
      p_link_segment = ^t_link_segment;

    ------------------------------------------------------------------------------------------------
    virtual abstract link_segment_code : t_link_segment;
    -- Linkování segmentu: kód.
    ------------------------------------------------------------------------------------------------
    virtual abstract link_segment_metadata : t_link_segment;
    -- Linkování segmentu: metadata.          
    ------------------------------------------------------------------------------------------------
    virtual abstract link_segment_const : t_link_segment;
    -- Linkování segmentu: konstanty.
    ------------------------------------------------------------------------------------------------
    virtual abstract link_segment_init_var : t_link_segment;
    -- Linkování segmentu: inicializované proměnné.
    ------------------------------------------------------------------------------------------------
    virtual abstract link_segment_uninit_var : t_link_segment;
    -- Linkování segmentu: neinicializované proměnné.
    ------------------------------------------------------------------------------------------------
    virtual abstract link_segment_import : t_link_segment;
    -- Linkování segmentu: importované entity.
    ------------------------------------------------------------------------------------------------
    virtual abstract link_segment_export : t_link_segment;
    -- Linkování segmentu: exportované entity.
    ------------------------------------------------------------------------------------------------
    virtual abstract trace (
        curr       : in pentity);                -- vyhodnocovaná entita
    -- Projde tabulku relokací symbolu CURR a pro každý symbol zavolí MARK.
    ------------------------------------------------------------------------------------------------
    static mark_single (
        curr       : in pentity);                -- entita
    -- Fáze 1: Označení jedné entity pro linkování.
    ------------------------------------------------------------------------------------------------
    static add_relocation (
        partition  : in t_partition_id;          -- ID cílové partition, do které směřuje relokace
        address    : in t_unsigned;              -- absolutní adresa relokabilního pole
        disposition: in t_relo_disposition);     -- dispozice relokace (relativní, absolutní,...)
    -- Zařadí adresu a dispozici relokabilního pole do seznamu relokací do cílové parition.
    ------------------------------------------------------------------------------------------------

    end linkresolver;



----------------------------------------------------------------------------------------------------
#separate public cl_ia32;
-- Vyhodnocovač cross-referencí a adres: IA-32.
----------------------------------------------------------------------------------------------------

end cl_resolver;
