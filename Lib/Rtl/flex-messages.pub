----------------------------------------------------------------------------------------------------
module public messages =
-- Messages.
-- Flex Run-time Library
-- Copyright (C) 1999-2003 A && L soft
----------------------------------------------------------------------------------------------------

type
  -- message code
  t_rtl_message_code   = protected unsigned 32;
  
  -- pointer to message data
  t_trl_message_data = array 0..$FFFF_FFFF of t_rtl_unsigned8;
  p_trl_message_data   = ^t_trl_message_data for machine_pointer use true;

  -- reference to flex message queue
  t_rtl_queue_ref = record
    queueptr       : t_rtl_pointer;
    end record;
  p_rtl_queue_ref = ^t_rtl_queue_ref for machine_pointer use true;

  -- flex message
  t_rtl_message = record
    code           : t_rtl_message_code;
    timeout        : t_rtl_timeout;
    replyto        : p_rtl_queue_ref;
    data           : t_trl_message_data;
    end record;

  t_rtl_internal_message = record
    
    msg            : t_rtl_message;
    end record;

  p_rtl_message = ^t_rtl_message for machine_pointer use true;

  -- message filtering callback
  t_rtl_message_filter_proc = procedure (
    msg            : in t_rtl_message)
    return t_rtl_logical8;

  -- message filter
  t_rtl_message_filter = string of t_rtl_message_filter_proc;

  -- queue type
  t_rtl_queue_type = enum
    rtl_queue_type_blocking_fifo;
    rtl_queue_type_lockfree_fifo;
    rtl_queue_type_blocking_heap;
    rtl_queue_type_lockfree_heap;
    end enum;

{
----------------------------------------------------------------------------------------------------
procedure rtl_queue_create(
    que            : out t_rtl_queue_ref);
-- create flex queue
----------------------------------------------------------------------------------------------------
procedure rtl_queue_discard(
    que            : in out t_rtl_queue_ref);
-- discard flex queue
----------------------------------------------------------------------------------------------------
procedure rtl_message_create(
    code           : in t_rtl_message_code;
    recipient      : in ref t_rtl_queue_ref;
    repltyto       : in ref t_rtl_queue_ref;
    msg            : out p_rtl_message);
-- create new message
----------------------------------------------------------------------------------------------------
procedure rtl_message_answer(
    code           : in t_rtl_message_code;
    msg            : in out p_rtl_message);
-- create answer message
----------------------------------------------------------------------------------------------------
procedure rtl_message_send(
    msg            : in p_rtl_message);
-- send message to recipient
----------------------------------------------------------------------------------------------------
procedure rtl_message_discard(
    msg            : in out p_rtl_message);   
-- discard message
----------------------------------------------------------------------------------------------------
procedure rtl_message_accept(
    recipient      : in ref t_rtl_queue_ref;
    filter         : in ref t_rtl_message_filter;
    msg            : out p_rtl_message);
-- return true when msg accepted
----------------------------------------------------------------------------------------------------
procedure rtl_message_try_accept(
    recipient      : in ref t_rtl_queue_ref;
    msg            : out p_rtl_message;
    filter         : in ref t_rtl_message_filter;
    milisec        : in t_rtl_timeout)
    return t_rtl_logical8;
-- return true when msg accepted
----------------------------------------------------------------------------------------------------
}

end messages;